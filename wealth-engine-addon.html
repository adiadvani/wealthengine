<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wealth Engine</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --glass-bg: rgba(255, 255, 255, 0.72);
      --glass-border: rgba(255, 255, 255, 0.5);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      --glass-blur: 20px;
      --text-primary: rgba(0, 0, 0, 0.85);
      --text-secondary: rgba(0, 0, 0, 0.55);
      --text-tertiary: rgba(0, 0, 0, 0.35);
      --accent: #007AFF;
      --accent-light: rgba(0, 122, 255, 0.12);
      --green: #34C759;
      --red: #FF3B30;
      --orange: #FF9500;
      --bg-gradient: linear-gradient(180deg, #F2F2F7 0%, #E5E5EA 100%);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      margin-bottom: 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .logo-text {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .status-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(52, 199, 89, 0.12);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--green);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      background: currentColor;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .rpp-input-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .rpp-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .rpp-input {
      width: 120px;
      padding: 10px 14px;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .rpp-input:focus {
      outline: none;
      background: white;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .btn {
      padding: 10px 18px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn:hover {
      background: #0066DD;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 900px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .stat-card {
      padding: 20px;
    }
    
    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    .stat-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .stat-change.positive {
      background: rgba(52, 199, 89, 0.12);
      color: var(--green);
    }
    
    .stat-change.negative {
      background: rgba(255, 59, 48, 0.12);
      color: var(--red);
    }
    
    .stat-subtext {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 6px;
    }
    
    .chart-section {
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .chart-controls {
      display: flex;
      gap: 4px;
      background: rgba(0, 0, 0, 0.04);
      padding: 4px;
      border-radius: 10px;
    }
    
    .chart-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .chart-btn.active {
      background: white;
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .chart-container {
      height: 320px;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
    }
    
    @media (max-width: 1000px) {
      .main-grid { grid-template-columns: 1fr; }
    }
    
    .holdings-section, .accounts-section {
      padding: 24px;
    }
    
    .holdings-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .holding-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 12px;
    }
    
    .holding-info {
      min-width: 0;
    }
    
    .holding-symbol {
      font-size: 15px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .holding-name {
      font-size: 12px;
      color: var(--text-tertiary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .holding-col {
      text-align: right;
      min-width: 80px;
    }
    
    .holding-col-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 2px;
    }
    
    .holding-col-value {
      font-size: 14px;
      font-weight: 600;
    }
    
    .holding-col-sub {
      font-size: 11px;
      color: var(--text-tertiary);
    }
    
    .gain-positive { color: var(--green); }
    .gain-negative { color: var(--red); }
    
    .holdings-header {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      margin-bottom: 8px;
    }
    
    .holdings-header span:not(:first-child) {
      text-align: right;
      min-width: 80px;
    }
    
    .account-group { margin-bottom: 16px; }
    
    .account-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 8px;
    }
    
    .account-group-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .account-group-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .account-group-name {
      font-size: 14px;
      font-weight: 600;
      text-transform: capitalize;
    }
    
    .account-group-total {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .account-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      margin-left: 22px;
      border-left: 2px solid rgba(0, 0, 0, 0.06);
    }
    
    .account-row.manual {
      border-left-color: var(--orange);
    }
    
    .account-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .account-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    
    .account-name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .account-institution {
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    .account-balance {
      font-size: 15px;
      font-weight: 600;
    }
    
    .account-balance.negative { color: var(--red); }
    
    .allocation-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .allocation-chart {
      height: 180px;
    }
    
    .empty-state {
      padding: 40px;
      text-align: center;
      color: var(--text-tertiary);
    }
    
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1000;
    }
    
    .debug-panel {
      position: fixed;
      bottom: 60px;
      right: 20px;
      width: 400px;
      max-height: 300px;
      overflow: auto;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 11px;
      white-space: pre-wrap;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header glass-panel">
      <div class="logo">
        <div class="logo-icon">W</div>
        <span class="logo-text">Wealth Engine</span>
      </div>
      <div id="statusPill" class="status-pill">
        <span class="status-dot"></span>
        <span>Connecting...</span>
      </div>
      <div class="rpp-input-group">
        <span class="rpp-label">Canada Life RPP</span>
        <input type="number" id="rppInput" class="rpp-input" step="0.01">
        <button id="rppSave" class="btn">Update</button>
      </div>
    </header>
    
    <div class="stats-grid">
      <div class="stat-card glass-panel">
        <div class="stat-label">Net Worth</div>
        <div class="stat-value" id="netWorthValue">--</div>
        <div class="stat-change" id="netWorthChange"></div>
        <div class="stat-subtext">Includes RPP</div>
      </div>
      <div class="stat-card glass-panel">
        <div class="stat-label">Wealthica</div>
        <div class="stat-value" id="wealthicaValue">--</div>
        <div class="stat-subtext">Synced accounts</div>
      </div>
      <div class="stat-card glass-panel">
        <div class="stat-label">Canada Life RPP</div>
        <div class="stat-value" id="rppValue">--</div>
        <div class="stat-subtext">Manual entry</div>
      </div>
      <div class="stat-card glass-panel">
        <div class="stat-label">30 Day Change</div>
        <div class="stat-value" id="monthlyChange">--</div>
        <div class="stat-subtext" id="monthlyChangeSubtext"></div>
      </div>
    </div>
    
    <div class="chart-section glass-panel">
      <div class="section-header">
        <h2 class="section-title">Net Worth</h2>
        <div class="chart-controls">
          <button class="chart-btn" data-range="6">6M</button>
          <button class="chart-btn" data-range="12">1Y</button>
          <button class="chart-btn" data-range="24">2Y</button>
          <button class="chart-btn active" data-range="all">All</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="netWorthChart"></canvas>
      </div>
    </div>
    
    <div class="main-grid">
      <div class="holdings-section glass-panel">
        <div class="section-header">
          <h2 class="section-title">Holdings</h2>
        </div>
        <div class="holdings-header">
          <span>Symbol</span>
          <span>Shares</span>
          <span>Avg Cost</span>
          <span>Value / Gain</span>
        </div>
        <div id="holdingsList" class="holdings-list">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
      
      <div class="accounts-section glass-panel">
        <div class="section-header">
          <h2 class="section-title">Accounts</h2>
        </div>
        <div id="accountsList"></div>
        <div class="allocation-section">
          <h3 class="section-title" style="font-size:15px;margin-bottom:16px">Allocation</h3>
          <div class="allocation-chart">
            <canvas id="allocationChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
  <div id="debugPanel" class="debug-panel"></div>

  <script src="https://wealthica.github.io/wealthica.js/dist/addon.min.js"></script>
  <script>
    const CANADA_LIFE_HISTORY = {
      "2023-09": 353.07, "2023-10": 1200, "2023-11": 2000, "2023-12": 2581.61,
      "2024-01": 3400, "2024-02": 4200, "2024-03": 5100, "2024-04": 6000,
      "2024-05": 6900, "2024-06": 7800, "2024-07": 8700, "2024-08": 9600,
      "2024-09": 10500, "2024-10": 11400, "2024-11": 13945.51, "2024-12": 14568.47,
      "2025-01": 15500, "2025-02": 17500, "2025-03": 18500, "2025-04": 19500,
      "2025-05": 21000, "2025-06": 22500, "2025-07": 24000, "2025-08": 25500,
      "2025-09": 26500, "2025-10": 27500, "2025-11": 28981.63, "2025-12": 30000,
      "2026-01": 32000
    };
    
    // Liability keywords - comprehensive list
    const LIABILITY_KEYWORDS = [
      'credit', 'visa', 'mastercard', 'amex', 'american express',
      'line of credit', 'loc', 'loan', 'mortgage', 'debt',
      'avion', 'cashback', 'rewards', 'infinite', 'platinum',
      'rbc visa', 'td visa', 'bmo', 'cibc', 'scotia'
    ];
    
    // Cash account keywords
    const CASH_KEYWORDS = [
      'chequing', 'checking', 'savings', 'saving', 'high interest',
      'daily interest', 'esavings', 'e-savings'
    ];
    
    let addon = null;
    let currentRPP = parseFloat(localStorage.getItem('wealthengine-rpp')) || 32000;
    let wealthicaData = { history: [], positions: [], institutions: [] };
    let netWorthChart = null;
    let allocationChart = null;
    let chartRange = 'all';
    let expandedCategories = { investment: true, cash: true, liability: true };
    let debugMode = false;
    
    function log(msg, data) {
      const panel = document.getElementById('debugPanel');
      const entry = `[${new Date().toLocaleTimeString()}] ${msg}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n`;
      panel.textContent = entry + panel.textContent;
      console.log(msg, data);
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none';
    }
    
    function formatCurrency(n) {
      if (n == null || isNaN(n)) return '--';
      const abs = Math.abs(n);
      if (abs >= 1e6) return `$${(n/1e6).toFixed(2)}M`;
      if (abs >= 1e3) return `$${(n/1e3).toFixed(1)}K`;
      return '$' + Math.round(n).toLocaleString();
    }
    
    function formatFull(n) {
      if (n == null || isNaN(n)) return '--';
      return '$' + n.toLocaleString('en-CA', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    
    function formatDate(d) {
      const date = new Date(d);
      const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${m[date.getMonth()]} '${String(date.getFullYear()).slice(2)}`;
    }
    
    function getMonthKey(d) {
      const date = new Date(d);
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
    }
    
    function getRPP(d) {
      const key = getMonthKey(d);
      let val = 0;
      for (const k of Object.keys(CANADA_LIFE_HISTORY).sort()) {
        if (k <= key) val = CANADA_LIFE_HISTORY[k];
        else break;
      }
      return val;
    }
    
    // Improved account classification
    function classifyAccount(account) {
      const name = (account.name || '').toLowerCase();
      const type = (account.type || account.category || '').toLowerCase();
      const balance = account.value || account.balance || account.cash || 0;
      
      // Check for liabilities first (most specific)
      for (const kw of LIABILITY_KEYWORDS) {
        if (name.includes(kw) || type.includes(kw)) {
          return 'liability';
        }
      }
      
      // Check if balance is negative (likely a liability)
      if (balance < 0) {
        return 'liability';
      }
      
      // Check for cash accounts
      for (const kw of CASH_KEYWORDS) {
        if (name.includes(kw) || type.includes(kw)) {
          return 'cash';
        }
      }
      
      // Default to investment
      return 'investment';
    }
    
    function initWealthica() {
      addon = new Addon();
      addon.on('init', (data) => { 
        log('Addon initialized', data);
        updateStatus('Live'); 
        loadData(); 
      });
      addon.on('reload', loadData);
      addon.on('update', o => log('Update:', o));
    }
    
    async function loadData() {
      updateStatus('Syncing...');
      try {
        const [hist, pos, inst] = await Promise.all([
          addon.request({method:'GET', endpoint:'history', query:{from:'2021-04-01', to:new Date().toISOString().split('T')[0]}}).catch(e => { log('History error', e); return []; }),
          addon.request({method:'GET', endpoint:'positions', query:{institutions:'', assets:true, groups:'', investments:''}}).catch(e => { log('Positions error', e); return []; }),
          addon.request({method:'GET', endpoint:'institutions'}).catch(e => { log('Institutions error', e); return []; })
        ]);
        
        wealthicaData = {history: hist||[], positions: pos||[], institutions: inst||[]};
        
        log('History loaded', { count: wealthicaData.history.length, sample: wealthicaData.history.slice(0,2) });
        log('Positions loaded', { count: wealthicaData.positions.length, sample: wealthicaData.positions.slice(0,3) });
        log('Institutions loaded', { count: wealthicaData.institutions.length, data: wealthicaData.institutions });
        
        updateStatus('Live');
        render();
      } catch(e) { 
        log('Load error', e); 
        updateStatus('Error'); 
      }
    }
    
    function updateStatus(t) {
      const p = document.getElementById('statusPill');
      const isErr = t === 'Error';
      p.innerHTML = `<span class="status-dot"></span><span>${t}</span>`;
      p.style.background = isErr ? 'rgba(255,59,48,0.12)' : 'rgba(52,199,89,0.12)';
      p.style.color = isErr ? '#FF3B30' : '#34C759';
    }
    
    function processHistory() {
      return (wealthicaData.history || []).map(p => {
        const d = p.date || p.d;
        const w = p.value || p.networth || p.v || 0;
        const r = getRPP(d);
        return {date: d, wealthica: w, rpp: r, corrected: w + r};
      }).sort((a,b) => new Date(a.date) - new Date(b.date));
    }
    
    function calcTotals() {
      let inv=0, cash=0, liab=0;
      (wealthicaData.institutions||[]).forEach(i => {
        const b = i.value || i.balance || i.cash || 0;
        const category = classifyAccount(i);
        
        if (category === 'liability') {
          liab += Math.abs(b);
        } else if (category === 'cash') {
          cash += Math.abs(b);
        } else {
          inv += b;
        }
      });
      return {inv, cash, liab};
    }
    
    function render() {
      renderStats();
      renderChart();
      renderAccounts();
      renderHoldings();
      renderAllocation();
    }
    
    function renderStats() {
      const h = processHistory();
      const t = calcTotals();
      const wTotal = t.inv + t.cash - t.liab;
      const net = wTotal + currentRPP;
      
      let change = 0;
      if (h.length >= 2) {
        const cur = h[h.length-1].corrected;
        const prev = h[Math.max(0, h.length-30)]?.corrected || h[0].corrected;
        change = cur - prev;
      }
      
      document.getElementById('netWorthValue').textContent = formatCurrency(net);
      document.getElementById('wealthicaValue').textContent = formatCurrency(wTotal);
      document.getElementById('rppValue').textContent = formatCurrency(currentRPP);
      document.getElementById('rppInput').value = currentRPP.toFixed(2);
      
      const mc = document.getElementById('monthlyChange');
      mc.textContent = `${change>=0?'+':''}${formatCurrency(change)}`;
      mc.style.color = change >= 0 ? '#34C759' : '#FF3B30';
      
      const pct = h.length > 30 ? (change / h[h.length-30]?.corrected * 100) : 0;
      document.getElementById('monthlyChangeSubtext').textContent = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
      
      const ce = document.getElementById('netWorthChange');
      ce.className = `stat-change ${change>=0?'positive':'negative'}`;
      ce.innerHTML = `${change>=0?'↑':'↓'} ${formatCurrency(Math.abs(change))}`;
    }
    
    // Downsample data to target number of points for smooth chart rendering
    function downsampleData(data, targetPoints) {
      if (data.length <= targetPoints) return data;
      
      const result = [];
      const step = (data.length - 1) / (targetPoints - 1);
      
      for (let i = 0; i < targetPoints; i++) {
        const idx = Math.round(i * step);
        result.push(data[idx]);
      }
      
      // Always include the last point for accuracy
      if (result[result.length - 1] !== data[data.length - 1]) {
        result[result.length - 1] = data[data.length - 1];
      }
      
      return result;
    }
    
    // Aggregate to weekly data points (every 7 days, taking the last value of each week)
    function aggregateWeekly(data) {
      if (data.length <= 100) return data;
      
      const result = [];
      let weekStart = null;
      let lastPoint = null;
      
      data.forEach(p => {
        const date = new Date(p.date);
        const weekNum = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
        
        if (weekStart !== weekNum) {
          if (lastPoint) result.push(lastPoint);
          weekStart = weekNum;
        }
        lastPoint = p;
      });
      
      if (lastPoint) result.push(lastPoint);
      return result;
    }
    
    function renderChart() {
      const h = processHistory();
      if (!h.length) return;
      
      let data = h;
      if (chartRange !== 'all') {
        const mo = parseInt(chartRange);
        const cut = new Date();
        cut.setMonth(cut.getMonth() - mo);
        data = h.filter(p => new Date(p.date) >= cut);
      }
      
      // Downsample for smooth rendering
      // For "all" view with lots of data, use weekly aggregation
      // For shorter ranges, use simple downsampling to ~150 points max
      let chartData;
      if (chartRange === 'all' && data.length > 200) {
        chartData = aggregateWeekly(data);
      } else if (data.length > 150) {
        chartData = downsampleData(data, 150);
      } else {
        chartData = data;
      }
      
      log(`Chart: ${data.length} points -> ${chartData.length} displayed`);
      
      const ctx = document.getElementById('netWorthChart').getContext('2d');
      if (netWorthChart) netWorthChart.destroy();
      
      // Subtle gradient fill - very light
      const grad = ctx.createLinearGradient(0, 0, 0, 320);
      grad.addColorStop(0, 'rgba(0,122,255,0.08)');
      grad.addColorStop(1, 'rgba(0,122,255,0)');
      
      netWorthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(p => p.date),
          datasets: [{
            data: chartData.map(p => p.corrected),
            borderColor: '#007AFF',
            backgroundColor: grad,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: '#007AFF',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            borderWidth: 2,
            borderJoinStyle: 'round',
            borderCapStyle: 'round'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {intersect: false, mode: 'index'},
          plugins: {
            legend: {display: false},
            tooltip: {
              backgroundColor: 'rgba(255,255,255,0.95)',
              titleColor: '#000',
              bodyColor: '#000',
              borderColor: 'rgba(0,0,0,0.1)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 10,
              displayColors: false,
              callbacks: {
                title: c => formatDate(c[0].label),
                label: c => formatFull(c.raw)
              }
            }
          },
          scales: {
            x: {
              grid: {display: false},
              border: {display: false},
              ticks: {
                color: 'rgba(0,0,0,0.4)', 
                maxTicksLimit: 8, 
                callback: function(v) { return formatDate(this.getLabelForValue(v)); }
              }
            },
            y: {
              grid: {color: 'rgba(0,0,0,0.04)'},
              border: {display: false},
              ticks: {color: 'rgba(0,0,0,0.4)', callback: v => formatCurrency(v)}
            }
          }
        }
      });
    }
    
    function renderAccounts() {
      const inst = wealthicaData.institutions || [];
      const el = document.getElementById('accountsList');
      const groups = {investment: [], cash: [], liability: []};
      
      // Add RPP first
      groups.investment.push({
        name: 'RPP - ClearPath 2065', 
        inst: 'Canada Life', 
        bal: currentRPP, 
        manual: true
      });
      
      inst.forEach(i => {
        const b = i.value || i.balance || i.cash || 0;
        if (Math.abs(b) < 0.01) return;
        
        const category = classifyAccount(i);
        const acc = {
          name: i.name || 'Account', 
          inst: i.provider_name || i.providerName || i.institution || '', 
          bal: Math.abs(b),
          rawBal: b
        };
        
        groups[category].push(acc);
        log(`Classified: ${i.name} -> ${category}`, { balance: b, type: i.type });
      });
      
      const colors = {investment: '#007AFF', cash: '#34C759', liability: '#FF3B30'};
      let html = '';
      
      Object.entries(groups).forEach(([cat, accs]) => {
        if (!accs.length) return;
        const tot = cat === 'liability' 
          ? accs.reduce((s,a) => s + a.bal, 0) 
          : accs.reduce((s,a) => s + a.bal, 0);
        const exp = expandedCategories[cat];
        
        html += `<div class="account-group">
          <div class="account-group-header" onclick="toggleCat('${cat}')">
            <div class="account-group-info">
              <div class="account-group-dot" style="background:${colors[cat]}"></div>
              <span class="account-group-name">${cat}</span>
            </div>
            <span class="account-group-total">${cat === 'liability' ? '-' : ''}${formatCurrency(tot)}</span>
          </div>
          ${exp ? accs.map(a => `
            <div class="account-row ${a.manual?'manual':''}">
              <div class="account-info">
                <div class="account-icon" style="background:${colors[cat]}15;color:${colors[cat]}">${a.name[0].toUpperCase()}</div>
                <div>
                  <div class="account-name">${a.name}</div>
                  <div class="account-institution">${a.inst}${a.manual?' • Manual':''}</div>
                </div>
              </div>
              <span class="account-balance ${cat==='liability'?'negative':''}">${cat==='liability'?'-':''}${formatFull(a.bal)}</span>
            </div>
          `).join('') : ''}
        </div>`;
      });
      
      el.innerHTML = html || '<div class="empty-state">No accounts</div>';
    }
    
    function renderHoldings() {
      const pos = wealthicaData.positions || [];
      const el = document.getElementById('holdingsList');
      
      if (!pos.length) { 
        el.innerHTML = '<div class="empty-state">No holdings data available</div>'; 
        return; 
      }
      
      // Sort by value descending
      const sorted = [...pos].sort((a,b) => (b.value||0) - (a.value||0));
      
      el.innerHTML = sorted.map(p => {
        // Handle various Wealthica data structures
        const sym = p.security?.symbol || p.symbol || p.ticker || '?';
        const name = p.security?.name || p.name || p.security?.description || '';
        const val = p.value || p.market_value || 0;
        const qty = p.quantity || p.units || p.shares || 0;
        const cost = p.book_value || p.cost || p.book || 0;
        const avgCost = qty > 0 ? cost / qty : 0;
        const gain = val - cost;
        const gainPct = cost > 0 ? (gain / cost * 100) : 0;
        const isPositive = gain >= 0;
        
        return `<div class="holding-row">
          <div class="holding-info">
            <div class="holding-symbol">${sym}</div>
            <div class="holding-name">${name.substring(0,30)}</div>
          </div>
          <div class="holding-col">
            <div class="holding-col-label">Shares</div>
            <div class="holding-col-value">${qty.toFixed(2)}</div>
          </div>
          <div class="holding-col">
            <div class="holding-col-label">Avg Cost</div>
            <div class="holding-col-value">${avgCost > 0 ? formatFull(avgCost) : '--'}</div>
          </div>
          <div class="holding-col">
            <div class="holding-col-label">Value</div>
            <div class="holding-col-value">${formatFull(val)}</div>
            <div class="holding-col-sub ${isPositive ? 'gain-positive' : 'gain-negative'}">
              ${isPositive ? '+' : ''}${formatFull(gain)} (${isPositive ? '+' : ''}${gainPct.toFixed(1)}%)
            </div>
          </div>
        </div>`;
      }).join('');
    }
    
    function renderAllocation() {
      const t = calcTotals();
      const ctx = document.getElementById('allocationChart').getContext('2d');
      if (allocationChart) allocationChart.destroy();
      
      const data = [
        {label: 'Investments', value: t.inv + currentRPP, color: '#007AFF'},
        {label: 'Cash', value: t.cash, color: '#34C759'},
        {label: 'Liabilities', value: t.liab, color: '#FF3B30'}
      ].filter(d => d.value > 0);
      
      allocationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(d => d.label),
          datasets: [{
            data: data.map(d => d.value), 
            backgroundColor: data.map(d => d.color), 
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'right', 
              labels: {
                color: 'rgba(0,0,0,0.6)', 
                padding: 12, 
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: c => `${c.label}: ${formatFull(c.raw)}`
              }
            }
          }
        }
      });
    }
    
    function toggleCat(c) { 
      expandedCategories[c] = !expandedCategories[c]; 
      renderAccounts(); 
    }
    window.toggleCat = toggleCat;
    
    function saveRPP() {
      const v = parseFloat(document.getElementById('rppInput').value);
      if (!isNaN(v) && v >= 0) { 
        currentRPP = v; 
        localStorage.setItem('wealthengine-rpp', v); 
        render(); 
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('rppSave').onclick = saveRPP;
      document.getElementById('rppInput').onkeypress = e => { if (e.key === 'Enter') saveRPP(); };
      document.querySelectorAll('.chart-btn').forEach(b => {
        b.onclick = () => {
          chartRange = b.dataset.range;
          document.querySelectorAll('.chart-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          renderChart();
        };
      });
      initWealthica();
    });
  </script>
</body>
</html>
